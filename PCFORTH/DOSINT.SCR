( PC-DOS File and Record Interface                   11/05/83 ) ;S                                                              Screens 7-11 contain an interface which can be used under       PC-DOS 1.x and is compatible with the CP/M interfaces used      on other LMI Forth packages.  Screens 14-73 contain the         PC-DOS 2.0 compatible interface with path and handle support.   See screens 2-3 also for description of data structures.                                                                        Ray Duncan                                                      Laboratory Microsystems, Inc.                                   4147 Beethoven Street                                           Los Angeles, CA 90066                                                                                                           this file created 14 September 1983                             revised 11/05/83 for PC/FORTH 2.                                                                                                ( Memory dump, byte format                           11/05/83 ) FORTH DEFINITIONS DECIMAL                                       : DUMP    ( addr  n  ---  )                                       BASE @ >R HEX CR CR 5 SPACES                                    16 0 DO I 3 .R LOOP 2 SPACES                                    16 0 DO I 0 <# # #> TYPE LOOP CR                                OVER + SWAP DUP 15 AND XOR DO                                   CR I 0 4 D.R SPACE                                              I 16 + I 2DUP                                                     DO I C@ SPACE 0 <# # # #> TYPE LOOP                             2 SPACES                                                        DO I C@ DUP 32 < OVER 126 > OR IF DROP 46 THEN                  EMIT LOOP                                                     16 +LOOP CR R> BASE ! ;                                                                                                                                                                       ( Handle Control Block                                9/14/83                                                                     The file/record interface for MS-DOS and PC-DOS 2.0             uses a new construct which is called a "Handle Control          Block".  The HCB is used by FORTH to store the file             specification, the 16 bit handle assigned by DOS, and           certain other parameters and flags.   Each HCB                  is created by a defining word; when the name of the             HCB is executed it returns the handle and a pointer to          a data area:                                                     offset       contents                                            0-1         handle                                              2-3         FORTH flags, 0 if file not opened/created           4           length of file specification string                 5+          ASCIIZ file spec. terminated by 0 byte       )                                                                  ( Directory Control Block                             9/19/83                                                                     The PC-DOS interface also uses a new construct called a         "Directory Control Block"  which is similar to the "Handle      Control Block".  The DCB is used by FORTH to store a path       specification which can be used to create, change, or           delete subdirectories.  Each DCB is created by a defining       word; when the name of the DCB is executed it returns a         pointer to the data area:                                                                                                        offset       contents                                            0           length of path specification string                 1+          ASCIIZ path spec. terminated by 0 byte                          maximum length 63 characters                  )                                                                                                                                 ( System messages )                                             empty stack                                                     dictionary full                                                 has incorrect address mode                                      is redefined                                                    is undefined                                                    disk address out of range                                       stack overflow                                                  disk error                                                                                                                                                                                                                                                                                                                      BASE must be DECIMAL                                            missing decimal point                                           PC/FORTH 2.0                             Laboratory Microsystems( System messages )                                             compilation only, use in definition                             execution only                                                  conditionals not paired                                         definition not finished                                         in protected dictionary                                         use only when loading                                           off current editing screen                                      declare vocabulary                                                                                                                                                                                                                                              illegal dimension in array definition                           negative array index                                            array index too large                                                                                                           ( 8086 Assembler messages )                                     16 bit register not allowed                                     8 bit register not allowed                                      address out of range                                            immediate data value not allowed                                missing source register                                         missing destination register                                    illegal operation                                               illegal operand                                                 instruction not implemented                                     illegal destination register                                    illegal source register                                         illegal condition code                                          register mismatch                                               destination address missing                                                                                                     ( PC-DOS 1.x File and Record Interface               11/05/83 ) FORTH DEFINITIONS DECIMAL                                                                                                       ( length of record i/o buffer, must be 128 in cp/m systems)     128 CONSTANT BUFFER-SIZE                                        ( length of fcb, displacement to actual i/o buffer )            37 CONSTANT BUFFER-OFFSET                                                                                                       ( used in the form:  FCB fcb-name )                             : FCB           CREATE  BUFFER-OFFSET BUFFER-SIZE +                                     HERE OVER ERASE ALLOT      DOES> ;      ( fcb-addr  ---  )                                              : SET-DMA       26 SWAP BUFFER-OFFSET + FDOS 2DROP ;            ( fcb-addr  ---  )                                              : ?BUFFER-ADDR  BUFFER-OFFSET + ;                               -->                                                             ( PC-DOS 1.x File and Record Interface for PC/FORTH  11/05/83 )                                                                 ( for all file operations, status code = 0FFh if )              ( operation failed, zero if operation successful. )                                                                             ( fcb-addr  ---  status-code )                                  : >FDOS         SWAP FDOS DROP 255 AND ;                        : OPEN-FILE     15 >FDOS ;                                      : CLOSE-FILE    16 >FDOS ;                                      : MAKE-FILE     22 >FDOS ;                                      : DELETE-FILE   19 >FDOS ;                                      : SEARCH-FILE   17 >FDOS ;                                      : NEXT-FILE     18 >FDOS ;                                      : RENAME-FILE   23 >FDOS ;                                      -->                                                                                                                             ( PC-DOS 1.x File and Record Interface for PC/FORTH  11/05/83 ) ( for all record operations, status code = buffer address )     ( if operation successful, zero if operation failed. )                                                                          ( fcb-addr  ---  status-code )                                  : READ-SEQ      DUP DUP SET-DMA 20 >FDOS 0=                                     IF BUFFER-OFFSET + ELSE DROP 0 THEN ;           : WRITE-SEQ     DUP DUP SET-DMA 21 >FDOS 0=                                     IF BUFFER-OFFSET + ELSE DROP 0 THEN ;                                                                           ( fcb-addr  record-number  ---  status-code )                   : READ-RANDOM   OVER 33 + ! DUP DUP SET-DMA 33 >FDOS                            0= IF BUFFER-OFFSET + ELSE DROP 0 THEN ;        : WRITE-RANDOM  OVER 33 + ! DUP DUP SET-DMA 34 >FDOS                            0= IF BUFFER-OFFSET + ELSE DROP 0 THEN ;        -->                                                             ( PC-DOS 1.x File and Record Interface for PC/FORTH  11/05/83 )                                                                 ( uses PC-DOS function 29H to format filename into fcb )                                                                        : PARSE-FILENM      ( fcb-addr  filename-addr  --- )              SWAP DUP 37 ERASE 1 parse-filename DROP ;                     -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( PC-DOS 1.x File and Record Interface for PC/FORTH  11/05/83 )                                                                 : (FILENAME) R@ COUNT 2+ R> + >R PARSE-FILENM ;                                                                                 : FILENAME      ( fcb-addr  ---  )                                 STATE @ IF                                                      COMPILE (FILENAME)                                              BL DUP WORD DUP C@ 2+ ALLOT COUNT + 1+ C!                               ELSE BL WORD 1+ PARSE-FILENM                                    THEN ;                            IMMEDIATE                                                                          : INPUT-FILENAME  ( fcb-addr  ---  )                                            ." Enter file specification: "                                  HERE 30 EXPECT HERE PARSE-FILENM   ;            ;S                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              ( PC-DOS 2.0 File Interface for PC/FORTH             09/21/83                                                                     Copyright 1983 Ray Duncan, Laboratory Microsystems Inc.    )                                                                  CR CR .( Loading PC-DOS 2.0 interface module )  CR                                                                              : CHECK-VERSION WSIZE 2 <> IF                                     CR CR                                                           ." This file requires PC/FORTH version 2.0 or greater."         CR CR 7 EMIT                                                    THEN ;                                                                                                                        CHECK-VERSION                                                   FORGET CHECK-VERSION                                            -->                                                                                                                             ( PC-DOS 2.0 File Interface     transients           11/14/83 ) ( screens 8 & 9 by Joe Barnhart )                                                                                               FORTH DEFINITIONS DECIMAL                                                                                                       VARIABLE LINKS 2 ALLOT ( DP, NFA)                                                                                               VARIABLE ASM_TOP                                                                                                                ' ASSEMBLER 4 + @ ASM_TOP !  ( save link to current top word)   -->                                                                                                                                                                                                                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     transients           11/14/83 )                                                                 : BEGIN-MOD                       ( nnnn  --- )                         HERE LINKS !              ( save the old DP )                   LATEST LINKS 2+ !         ( and NFA of latest word )            S0 @ SWAP 384 + - DP ! ;  ( space for PAD and STACK )                                                                   : END-MOD  LINKS @ DP ! ;       ( restore the old DP )                                                                          : FORGET-MOD    LINKS 2+ @      ( NFA of "old" latest word )            LINKS @ N>LINK ! ;      ( LFA of most recent word )     -->                                                                                                                                                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     Assembler overlay    09/17/83                                                                     Copyright 1983 Ray Duncan, Laboratory Microsystems Inc.    )                                                                  HEX                                                                                                                             080 CONSTANT SCRATCH_BUFF                                                                                                       DECIMAL                                                         CR                                                              8000 BEGIN-MOD     7 LOAD-USING ASM86     END-MOD               CR .( Assembler has been overlaid as transient.)                CR .( Now loading PC-DOS 2.0 interface code.)                   CR                                                              -->                                                                                                                             ( PC-DOS 2.0 File Interface     ASCIIZ"              11/14/83                                                                     Compiling: stores the string preceded by 1-byte count                      and terminated by a zero byte.                       Executing: leaves addr of count byte on the stack.          )                                                                 : (ASCIIZ")     R@ DUP C@ 1+ R> + >R ;                                                                                          : ASCIIZ"       ?COMP COMPILE (ASCIIZ")                                         ASCII "  WORD   ( returns HERE )                                C@ 1+ DUP HERE C!                                               ALLOT 0 C,   ; IMMEDIATE                                                                                                                                                        -->                                                                                                                             ( PC-DOS 2.0 File Interface     status codes         09/14/83 ) DECIMAL                                                         ( status --- )                                                  : .STATUS BASE @ >R HEX                                            CR ." Status = " DUP .  ." H   ---  "     CASE                 -1 OF  ." end-of-file" ENDOF                                     0 OF  ." successful call "  ENDOF                               1 OF  ." invalid function number" ENDOF                         2 OF  ." file not found" ENDOF                                  3 OF  ." path not found" ENDOF                                  4 OF  ." no handles left" ENDOF                                 5 OF  ." access denied"  ENDOF                                  6 OF  ." invalid handle " ENDOF                                 7 OF  ." memory control blocks destroyed" ENDOF              -->                                                                                                                             ( PC-DOS 2.0 File Interface     status codes         09/14/83 )                                                                    8 OF  ." insufficient memory " ENDOF                            9 OF  ." invalid memory block address " ENDOF                  10 OF  ." invalid environment"  ENDOF                           11 OF  ." invalid format" ENDOF                                 12 OF  ." invalid access code" ENDOF                            13 OF  ." invalid data " ENDOF                                  15 OF  ." invalid drive was specified" ENDOF                    16 OF  ." attempted to remove the current directory" ENDOF      17 OF  ." not same device" ENDOF                                18 OF  ." no more files" ENDOF                                 100 OF  ." disk full" ENDOF                                     101 OF  ." file not open" ENDOF                                -->                                                                                                                             ( PC-DOS 2.0 File Interface     status codes         09/14/83 )                                                                   ( otherwise )                                                   ." unknown "                                                    ENDCASE R> BASE !                                               CR CR ." Stack contents:" CR                                    .STACK ;                                                                                                                                                                                      -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     dump handle block    09/14/83                                                                     Display contents of Handle Control Block:  handle_pars --- )  : .HCB          BASE @ >R HEX  CR DROP                                          DUP   CR         ." Handle addr = "  U.                         DUP @ CR         ." Handle =      "  U.                         DUP 2+ @ CR      ." Handle stat = "  U.                         4 + DUP 1+ SWAP C@                                                           CR  ." Filespec    = " TYPE                        CR CR R> BASE ! ;                                                                                               ( display contents of directory control block:                    directory_par  ---                                         )  : .DCB          COUNT TYPE ;                                    -->                                                                                                                             ( PC-DOS 2.0 File Interface     display attribute    09/14/83 ) HEX                                                             ( attrib --- )                                                  : .ATTRIB       BASE @ >R HEX DUP                                               CR ." File attribute = " . ." : "                               DUP 01 AND IF  ." read-only "         THEN                      DUP 02 AND IF  ." hidden "            THEN                      DUP 04 AND IF  ." system "            THEN                      DUP 08 AND IF  ." volume "      THEN                            DUP 10 AND IF  ." subdirectory "      THEN                      DUP 20 AND IF  ." archive "   THEN                              CR  DROP  R> BASE ! ;                                                                                           -->                                                                                                                             system files IBMBIO.COM and IBMDOS.COM marked as 01+02+04       ( PC-DOS 2.0 File Interface     Handle               09/14/83                                                                     build file handle                                               compiling:    HANDLE handle_block_name                                        automatically sets file specification to NUL      executing:    ---  pfa  dos_handle   if file open                             ---  pfa  0            if file not open       ) HEX                                                             : HANDLE        CREATE  0 , 0 ,              ( handle, status )                 HERE 40 ERASE        ( zero out filespec area )                 03 C,  ASCII N C,  ASCII U C,      ( length & )                 ASCII L C,  0 C,               ( NUL filename )                 03C ALLOT           ( allow max filespec space)                 DOES> DUP @ ;        ( return address, handle ) -->                                                                                                                             ( PC-DOS 2.0 File Interface     Directory            09/19/83                                                                     Build directory control block.                                  compiling:    DIRECTORY  directory_block_name                                 automatically sets path specification to \        executing:    ---  pfa   for use by directory functions                       MAKE-DIR, CHANGE-DIR, and KILL-DIR.                             the actual ASCIIZ string is at pfa+1          )                                                                 : DIRECTORY     CREATE   HERE 40 ERASE                                                   1 C,  ASCII \ C,  03E ALLOT                            DOES>  ;                                                                                                        DIRECTORY ROOT  ( preallocate a DCB for the root directory )                                                                    -->                                                             ( PC-DOS 2.0 File Primitives    Predefined Handles   09/16/83                                                                   ( store handle into HCB, set flags = file prev opened )         : handle-enable         ( handle_pars handle --- )                      SWAP DROP OVER ! 1 SWAP 2+ ! ;                                                                                          ( these standard handles are pre-defined by PC-DOS 2.0 and        do not need to be opened before use.  STD-INPUT and             STD-OUTPUT can be redirected, the other three may not. )                                                                      HANDLE STD-INPUT            STD-INPUT  0 handle-enable          HANDLE STD-OUTPUT           STD-OUTPUT 1 handle-enable          HANDLE STD-ERROR            STD-ERROR  2 handle-enable          HANDLE STD-AUX              STD-AUX    3 handle-enable          HANDLE STD-LIST             STD-LIST   4 handle-enable          -->                                                             ( PC-DOS 2.0 File Primitives    Make File            09/17/83                                                                     Proper PC-DOS function name is Create, but this is not          used in order to avoid conflict with the Forth CREATE.          Make a new file, or truncate an existing file to zero length.   string_addr  --- handle >0                                      string_addr  --- status <0                                 )                                                                  CODE make       DX POP              ( DS:DX = addr of filespec)                 CX, CX SUB               ( normal file attrib )                 AH, # 03C MOV  21 INT            ( PCDOS call )                 1$ JNB            ( return handle if no error )                 AX NEG                    ( return neg status )         1$:     AX PUSH         NEXT,  END-CODE                 -->                                                                                                                             ( PC-DOS 2.0 File Primitives    Delete               09/14/83                                                                     Delete a file from a specified directory                        string_addr  --- zero=success                                                --- status <0=error                                status codes on page D-14 of DOS 2.0 manual                 )                                                                 CODE delete     DX POP              ( DS:DX = addr of filespec)                 CX, CX SUB               ( normal file attrib )                 AH, # 041 MOV  21 INT            ( PCDOS call )                 1$ JNB            ( return handle if no error )                 AX NEG  2$ JMP            ( return neg status )         1$:     AX, # 0 MOV                                             2$:     AX PUSH  NEXT, END-CODE                         -->                                                                                                                             ( PC-DOS 2.0 File Primitives    Change file mode     09/14/83     Read or set file attribute                                      string_addr  attrib  function_code  --- attribute >0                                                --- status <0               function code = 0 read,  = 1 write attribute                    status codes on page D-14 of DOS 2.0 manual                 )                                                                 CODE chmode     AX POP                         ( function code)                 CX POP                               ( attrib )                 DX POP              ( DS:DX = addr of filespec)                 AH, # 043 MOV  21 INT            ( PCDOS call )                 1$ JNB                     ( jump if no error )                 AX NEG  AX PUSH  2$ JMP   ( return neg status )         1$:     CX PUSH                       ( return attrib )         2$:     NEXT, END-CODE                                  -->                                                             ( PC-DOS 2.0 File Primitives    Open                 09/14/83                                                                     open a file                                                     string_addr  access_type   ---   > 0  = handle, success                                          < 0  = ERROR status            access_type:  0=read  1=write  2=read and write                 status codes on page D-14 of DOS 2.0 manual                 )                                                                 CODE open       AX POP                                 ( mode )                 DX POP              ( DS:DX = addr of filespec)                 AH, # 03D MOV  21 INT            ( PCDOS call )                 1$ JNB            ( return handle if no error )                 AX NEG                    ( return neg status )         1$:     AX PUSH   NEXT, END-CODE                        -->                                                                                                                             ( PC-DOS 2.0 File Primitives    Close                09/14/83                                                                     close a file                                                    handle  ---   status > 0  success                                             status < 0  error                                 status codes on page D-14 of DOS 2.0 manual                 )                                                                 CODE close      BX POP                          ( BX:= handle )                 AH, # 03E MOV  21 INT                                           1$ JNB                     ( jump if no error )                 AX NEG  2$ JMP            ( return neg status )         1$:     AX, # 0 MOV                                             2$:     AX PUSH    NEXT,  END-CODE                      -->                                                                                                                                                                                             ( PC-DOS 2.0 File Primitives    Rename               09/19/83                                                                     Rename a file, can be used to move between directories          addr_old_name  addr_new_name  ---  0     success                                              ---  <0    ERROR status           status codes on page D-14 of DOS 2.0 manual                 )                                                                 CODE rename     AX, DS MOV  ES, AX MOV   ( ensure addressable )                 DI POP                             ( new name )                 DX POP                             ( old name )                 AH, # 056 MOV  21 INT                                           1$ JNB              ( return zero if no error )                 AX NEG  2$ JMP            ( return neg status )         1$:     AX, AX XOR                                              2$:     AX PUSH         NEXT,  END-CODE                 -->                                                             ( PC-DOS 2.0 File Primitives    Read                 09/14/83                                                                     Read from file or device                                        handle  bytes_to_read  buffer_addr  ---  bytes read >0                                              ---  0 implies EOF                                              ---  error if <0            status codes on page D-14 of DOS 2.0 manual                 )                                                                 CODE read       DX POP                    ( DS:DX= buffer addr)                 CX POP                               ( length )                 BX POP                               ( handle )                 AH, # 03F MOV  21 INT            ( PCDOS call )                 1$ JNB                     ( jump if no error )                 AX NEG                    ( return neg status )         1$:     AX PUSH         NEXT, END-CODE                  -->                                                             ( PC-DOS 2.0 File Primitives    Write                09/14/83                                                                     Write to file or device                                         handle  bytes_to_write  buffer_addr  ---  bytes written >0                                           ---  error if <0           If bytes_written <> bytes_to write, media is probably full.     Status codes on page D-14 of DOS 2.0 manual.                )                                                                 CODE write      DX POP                    ( DS:DX= buffer addr)                 CX POP                               ( length )                 BX POP                               ( handle )                 AH, # 040 MOV  21 INT            ( PCDOS call )                 1$ JNB                     ( jump if no error )                 AX NEG                    ( return neg status )         1$:     AX PUSH         NEXT, END-CODE                  -->                                                             ( PC-DOS 2.0 File Primitives    Move pointer         09/14/83                                                                     Move the file read/write pointer                                handle  method  offset<double> ---  pointer<double>                                            ---  error<double> if <0         method 0= abs offset, 1=current loc+offset, 2=EOF+offset        Status codes on page D-14 of DOS 2.0 manual.                )                                                                 CODE lseek      CX POP  DX POP        ( CX:DX= desired offset )                 AX POP                               ( method )                 BX POP                               ( handle )                 AH, # 042 MOV  21 INT            ( PCDOS call )                 1$ JNB                     ( jump if no error )                 AX NEG  CWD               ( return neg status )         1$:     AX PUSH  DX PUSH  NEXT, END-CODE ( push DX:AX ) -->                                                             ( PC-DOS 2.0 File Primitives    Duplicate handle     09/14/83                                                                     Duplicate a file handle                                         handle  ---  new_handle > 0                                             ---  error < 0                                          status codes on page D-14 of DOS 2.0 manual                 )                                                                 CODE dup        BX POP                               ( handle )                 AH, # 045 MOV  21 INT            ( PCDOS call )                 1$ JNB                     ( jump if no error )                 AX NEG                    ( return neg status )         1$:     AX PUSH  NEXT, END-CODE                         -->                                                                                                                                                                                                                                                             ( PC-DOS 2.0 File Primitives    Force dup of handle  09/14/83                                                                     Force duplicate of a file handle                                handle1 handle2  ---  success > 0                                                ---  error < 0                                 Status codes on page D-14 of DOS 2.0 manual.                )                                                                 CODE forcedup   BX POP                             ( handle 2 )                 CX POP                             ( handle 1 )                 AH, # 046 MOV  21 INT            ( PCDOS call )                 1$ JNB                     ( jump if no error )                 AX NEG                    ( return neg status )         1$:     AX PUSH  NEXT, END-CODE                         -->                                                                                                                                                                                             ( PC-DOS 2.0 File Primitives    Get directory        09/17/83                                                                     Get current directory for specified drive into SCRATCH_BUFF     drive  ---  success > 0                                                ---  error < 0                                           Directory specification string terminates with 0 byte,          does not include drive letter, does not start with "\"      )                                                                 CODE getdir     DI, SI MOV                    ( save FORTH IP )                 SI, # SCRATCH_BUFF MOV   ( DS:SI = buffer addr)                 DX POP                                ( drive )                 AH, # 047 MOV  21 INT            ( PCDOS call )                 SI, DI MOV  1$ JNB         ( jump if no error )                 AX NEG                    ( return neg status )         1$:     AX PUSH  NEXT, END-CODE                         -->                                                             ( PC-DOS 2.0 File Primitives    Find first match     09/30/83     find first matching file for ASCIIZ file spec                   returned params placed into SCRATCH_BUFF                        ASCIIZ_addr  attrib  ---   success > 0                                               ---   error < 0                            status codes: page D-14, params page D-49 of DOS 2.0 manual )                                                                 CODE find       DX, # SCRATCH_BUFF MOV              ( set dta )                 AH, # 1A MOV  21 INT                                            CX POP                               ( attrib )                 DX POP                   ( get file spec addr )                 AH, # 04E MOV   21 INT           ( call PCDOS )                 1$ JNB                     ( jump if no error )                 AX NEG                    ( return neg status )         1$:     AX PUSH  NEXT, END-CODE                         -->                                                             ( PC-DOS 2.0 File Primitives    Find next match      09/17/83                                                                     find next matching file for ASCIIZ file spec                    assumes params from previous match are in SCRATCH_BUFF                  ---   success > 0                                               ---   error < 0                                         status codes: page D-14, params page D-49 of DOS 2.0 manual )                                                                 CODE next       DX, # SCRATCH_BUFF MOV              ( set dta )                 AH, # 1A MOV    21 INT                                          AH, # 04F MOV   21 INT           ( call PCDOS )                 1$ JNB                     ( jump if no error )                 AX NEG                    ( return neg status )         1$:     AX PUSH  NEXT, END-CODE                         -->                                                                                                                             ( PC-DOS 2.0 File Primitives    Mkdir                09/19/83                                                                     Create a subdirectory.                                          string_addr  --- zero=success                                                --- status <0=error                                status codes on page D-14 of DOS 2.0 manual                 )                                                                 CODE mkdir      DX POP              ( DS:DX = addr of filespec)                 AH, # 039 MOV  21 INT            ( PCDOS call )                 1$ JNB            ( return handle if no error )                 AX NEG  2$ JMP            ( return neg status )         1$:     AX, # 0 MOV                                             2$:     AX PUSH  NEXT, END-CODE                                                                                         -->                                                                                                                             ( PC-DOS 2.0 File Primitives    Rmdir                09/19/83                                                                     Remove a subdirectory.                                          string_addr  --- zero=success                                                --- status <0=error                                Note status code= -5 returned if directory is not empty.    )                                                                 CODE rmdir      DX POP              ( DS:DX = addr of filespec)                 AH, # 03A MOV  21 INT            ( PCDOS call )                 1$ JNB            ( return handle if no error )                 AX NEG  2$ JMP            ( return neg status )         1$:     AX, # 0 MOV                                             2$:     AX PUSH  NEXT, END-CODE                                                                                         -->                                                                                                                             ( PC-DOS 2.0 File Primitives    Chdir                09/19/83                                                                     Change the current directory.                                   string_addr  --- zero=success                                                --- status <0=error                                status codes on page D-14 of DOS 2.0 manual                 )                                                                 CODE chdir      DX POP              ( DS:DX = addr of filespec)                 AH, # 03B MOV  21 INT            ( PCDOS call )                 1$ JNB            ( return handle if no error )                 AX NEG  2$ JMP            ( return neg status )         1$:     AX, # 0 MOV                                             2$:     AX PUSH  NEXT, END-CODE                                                                                         -->                                                                                                                             ( PC-DOS 2.0 File Interface     MAKE-FILE            09/14/83                                                                     handle_par  ---  0 if successful                                            ___  <>0 if error status                        )                                                                 : MAKE-FILE     DROP DUP 5 + make DUP 0<                                        IF   SWAP 0 OVER ! 0 SWAP 2+ !                                       NEGATE                                                     ELSE OVER ! 1 SWAP 2+ ! 0                                       THEN ;                                          -->                                                                                                                                                                                                                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     OPEN-FILE            09/17/83                                                                     Open a file for read and write access.                          If the file carries the read-only attribute, this               function will fail; use OPEN-FILE-R/O instead.                  handle_par  ---  0 if successful                                            ___  <>0 if error status                        )                                                                 : OPEN-FILE     DROP DUP 5 + ( addr ) 2 ( access_type )                         open DUP 0<                                                     IF   SWAP 0 OVER ! 0 SWAP 2+ !                                       NEGATE                                                     ELSE OVER ! 1 SWAP 2+ ! 0                                       THEN ;                                          -->                                                                                                                             ( PC-DOS 2.0 File Interface     OPEN-FILE-R/O        09/17/83                                                                     Open a file for read access only. Any write function will       fail regardless of the file's attribute.                        handle_par  ---  0 if successful                                            ___  <>0 if error status                        )                                                                 : OPEN-FILE-R/O                                                                 DROP DUP 5 + ( addr ) 0 ( access_type )                         open DUP 0<                                                     IF   SWAP 0 OVER ! 0 SWAP 2+ !                                       NEGATE                                                     ELSE OVER ! 1 SWAP 2+ ! 0                                       THEN ;                                          -->                                                                                                                             ( PC-DOS 2.0 File Interface     CLOSE-FILE           09/14/83                                                                     handle_par  ---  0 if successful                                            ___  <>0 if error status                        )                                                                 : CLOSE-FILE    close DUP 0<                                                    IF     SWAP DROP NEGATE                                         ELSE   SWAP 0 OVER ! 0 SWAP 2+ !                                       DROP 0                                                   THEN ;                                          -->                                                                                                                                                                                                                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     KILL-FILE            09/14/83                                                                     handle_par  ---  0 if successful                                            ___  <>0 if error status                        )                                                                 : KILL-FILE     OVER 2+ @                                                       ( if file open, close it to release handle)                     IF    2DUP CLOSE-FILE DROP                                      THEN  DROP DUP 5 + delete DUP 0<                                IF    SWAP DROP NEGATE                                          ELSE  SWAP 0 OVER ! 0 SWAP 2+ !                                       DROP 0                                                    THEN ;                                          -->                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     GET-ATTRIB           09/14/83                                                                     handle_par  ---  Attrib  ZERO    if successful                              ___  <>0             if error status  )                                                                           : GET-ATTRIB    DROP 5 + 0 0 chmode DUP 0<                                      IF     NEGATE            ( return error status)                 ELSE   0                                                        THEN ;                                          -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     SET-ATTRIB           09/14/83                                                                     handle_par attrib   ---  ZERO    if successful                                      ---  <>0     if error status            )                                                                 : SET-ATTRIB    >R DROP 5 + R> 1 chmode DUP 0<                                  IF     NEGATE            ( return error status)                 ELSE   DROP 0                                                   THEN ;                                          -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     READ                 09/14/83                                                                     handle_par bytes buffer_addr ---  bytes_read 0   success                                     ---  -1             EOF                                         ---  >0             error status)                                                                : READ          read SWAP DROP DUP 0>                                           IF    0                                                         ELSE  DUP 0=                                                          IF    DROP -1                                                   ELSE  NEGATE                                                    THEN                                                      THEN ;                                          -->                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     WRITE                11/05/83                                                                     handle_par bytes buffer_addr ---  bytes_written 0 success                                    ---  >0              error stat.)                                                                : WRITE         1 PICK >R               ( save copy of length)                  write SWAP DROP DUP 0<                                          IF    NEGATE R> DROP                                            ELSE  DUP R> <>                                                       IF    DROP 100    ( if bytes written )                          ELSE  0           ( don't match request)                        THEN              ( disk must be full )                   THEN ;                                          -->                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     SEEK-ABS             09/15/83                                                                     move the file pointer to an absolute byte offset                handle_par  offset<double>   ---  0    success                                               ---  <>0  status               )                                                                 : SEEK-ABS      0 ROT ROT       ( method: absolute offset )                     lseek  2DUP  0. D<                                              IF    DNEGATE DROP                                              ELSE  2DROP 0                                                   THEN SWAP DROP ;                                                                                                -->                                                                                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     SEEK-REL             09/15/83                                                                     move the file pointer to an offset relative to current loc.     handle_par  offset<double>   ---  0    success                                               ---  <>0  status               )                                                                 : SEEK-REL      1 ROT ROT                                                       lseek  2DUP  0. D<                                              IF    DNEGATE DROP                                              ELSE  2DROP 0                                                   THEN SWAP DROP ;                                                                                                -->                                                                                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     SEEK-EOF             09/15/83                                                                     move the file pointer to an offset relative to EOF              handle_par  offset<double>   ---  0    success                                               ---  <>0  status               )                                                                 : SEEK-EOF      2 ROT ROT                                                       lseek  2DUP  0. D<                                              IF    DNEGATE DROP                                              ELSE  2DROP 0                                                   THEN SWAP DROP ;                                                                                                -->                                                                                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     ?OFFSET              09/15/83                                                                     return the current absolute byte offset of file pointer         handle_par  ---  offset<double>                             )                                                                 : ?OFFSET       SWAP DROP 1 0.                                                  lseek  2DUP  0. D<                                              IF    2DROP 0.  THEN ;                                                                                          -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     ?FILESIZE            09/15/83                                                                     return the size of the file in bytes                            handle_par  ---  size<double>                              )                                                                  : ?FILESIZE     SWAP DROP 2 0.                                                  lseek  2DUP  0. D<                                              IF    2DROP 0.  THEN ;                                                                                          -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     GET-DIR              09/17/83                                                                     Get the current directory for specified drive.                  ASCIIZ string is left in SCRATCH_BUFF.                          Drive code is integer 0-63; 0=default, 1=A, etc.                Do not use this call between SEARCH-FIRST and SEARCH-NEXT.                                                                      drive  ---  0     success                                              ---  <>0   error status                             )                                                                  : GET-DIR       getdir  DUP 0<                                                  IF      NEGATE                                                  ELSE    DROP 0                                                  THEN ;                                          -->                                                                                                                             ( PC-DOS 2.0 File Interface     .DIR                 09/17/83                                                                     display current directory for specified drive                                                                                   drive ---                                                   )                                                                 : .DIR          getdir DROP 03F 0                                               DO      I SCRATCH_BUFF + C@ ?DUP                                        IF     EMIT                                                     ELSE   LEAVE                                                    THEN                                                    LOOP ;                                          -->                                                                                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     .FILENAME            09/17/83                                                                     Display path/file specification in HCB                                                                                          handle_pars ---                                             )                                                                 : .FILENAME     DROP 4 + COUNT TYPE ;                                                                                                                                                           -->                                                                                                                                                                                                                                                                                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     SEARCH-FIRST         09/30/83                                                                     Search for the first file matching path/file specification.     Returned parameters are placed in SCRATCH_BUFF.                 See page D-49 of PCDOS 2.0 Manual.                                                                                              handle_pars  attrib   ---   0          success                                        ---   <>0        error status         )                                                                 : SEARCH-FIRST  SWAP DROP SWAP 5 + SWAP find DUP 0<                             IF NEGATE                                                       ELSE DROP 0                                                     THEN ;                                          -->                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     SEARCH-NEXT          09/17/83                                                                     Search for the next file matching path/file specification.      Must be preceded by SEARCH-FIRST.  Inputs to function are       assumed to be in SCRATCH_BUFF, returned parameters are          left at same location.  This function takes no inputs           from the stack!  See page D-49 of PC-DOS 2.0 Manual.                                                                                    ---   0        success                                          ---   <>0        error status                       )                                                                 : SEARCH-NEXT   next DUP 0<                                                     IF NEGATE                                                       ELSE DROP 0                                                     THEN ;                                          -->                                                             ( PC-DOS 2.0 File Interface     RENAME               09/15/83                                                                     Rename a file.  Can be used to move files from one directory    to another.  Drive cannot be changed.                                                                                           handle1_pars  handle2_pars   ---   0    success                                              ---   <>0  ERROR status       )                                                                  : RENAME-FILE   DROP >R DROP 5 + R> 5 + rename  DUP 0<                          IF NEGATE                                                       ELSE DROP 0                                                     THEN ;                                                                                                          -->                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     INPUT-FILENAME       09/16/83                                                                     Read a file specification from the terminal into                the handle control block.                                                                                                       handle_pars   ---                                           )                                                                 : here-length   0 BEGIN DUP HERE + C@ WHILE 1+ REPEAT ;                                                                         : INPUT-FILENAME   DROP DUP >R                     ( save PFA )         4 + 40 ERASE       ( clear out old file specification )         HERE 03F EXPECT                        ( read console )         HERE R@ 5 +                       ( from, to addresses)         here-length DUP R> 4 + C!              ( store length )         CMOVE ;                           ( into handle block ) -->                                                             ( PC-DOS 2.0 File Interface     FILENAME             09/16/83                                                                   ( runtime routine for FILENAME, compiled followed by a            string literal inside a colon definition )                                                                                    : filename      DROP DUP 4 + 40 ERASE                                           R@ C@ OVER 4 + C!                                               5 + R@ 1+ SWAP                                                  R@ C@ CMOVE                                                     R@ C@ 2+ R> + >R ;                              -->                                                                                                                                                                                                                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     FILENAME, cont.      11/05/83     If executing, move a file specification from the input stream   into the designated handle control block.  If compiling, save   the file spec. as a string literal which is moved into the      handle block at execution time.                                                                                                 handle_pars  ---                                           )                                                                  : FILENAME      STATE @                                            IF    COMPILE filename                                                BL DUP WORD DUP C@ 2+ ALLOT COUNT + 1+ C!                 ELSE  DROP DUP 40 ERASE  BL WORD C@ OVER 4 + C!                       HERE 1+ SWAP 5 + HERE C@ CMOVE                            THEN ; IMMEDIATE                                                                                                             -->                                                             ( PC-DOS 2.0 File Interface     MAKE-DIR             09/19/83                                                                     Make a new subdirectory.                                                                                                        directory_par   ---  status                                 )                                                                 : MAKE-DIR      1+ mkdir DUP 0<                                                 IF     NEGATE                                                   ELSE   DROP 0                                                   THEN ;                                          -->                                                                                                                                                                                                                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     CHANGE-DIR           09/19/83                                                                     Change the current subdirectory.                                                                                                directory_par   ---  status                                 )                                                                 : CHANGE-DIR    DEPTH 1 < 1 ?ERROR                                              1+ chdir DUP 0<                                                 IF     NEGATE                                                   ELSE   DROP 0                                                   THEN ;                                          -->                                                                                                                                                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     KILL-DIR             09/19/83                                                                     Remove subdirectory.                                                                                                            directory_par   ---  status                                 )                                                                 : KILL-DIR      1+ rmdir DUP 0<                                                 IF     NEGATE                                                   ELSE   DROP 0                                                   THEN ;                                          -->                                                                                                                                                                                                                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     INPUT-DIRNAME        09/19/83                                                                     Read a file specification from the terminal into                the handle control block.                                                                                                       directory_par  ---                                          )                                                                 : INPUT-DIRNAME    DUP >R                          ( save PFA )         40 ERASE           ( clear out old dir. specification )         HERE 03F EXPECT                        ( read console )         HERE R@ 1+                        ( from, to addresses)         here-length DUP R> C!                  ( store length )         CMOVE ;                             ( into dir. block ) -->                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     DIRNAME              09/19/83                                                                     runtime routine for DIRNAME, compiled followed by a             string literal inside a colon definition                   )                                                                  : dirname       DUP 40 ERASE                                                    R@ C@ OVER C!                                                   1+ R@ 1+ SWAP                                                   R@ C@ CMOVE                                                     R@ C@ 2+ R> + >R ;                              -->                                                                                                                                                                                                                                                                                                                                                                                             ( PC-DOS 2.0 File Interface     DIRNAME, cont.       11/05/83     If executing, move a dir. specification from the input stream   into the designated dir. control block.  If compiling, save     the dir. spec. as a string literal which is moved into the      directory block at execution time.                                                                                              directory_par  ---                                         )                                                                  : DIRNAME       STATE @                                            IF    COMPILE dirname                                                 BL DUP WORD DUP C@ 2+ ALLOT COUNT + 1+ C!                 ELSE  DUP 40 ERASE  BL WORD C@ OVER C!                                HERE 1+ SWAP 1+ HERE C@ CMOVE                             THEN ; IMMEDIATE                                                                                                             -->                                                             ( PC-DOS 2.0 File Interface     End of load          11/14/83 )                                                                 DECIMAL                                                                                                                         FORGET-MOD      ( discard assembler )                                                                                           ASM_TOP @ ' ASSEMBLER 4 + ! ( put back old top of vocab )                                                                       CR CR .( PC-DOS 2.0 interface compilation completed.)           CR    SP@ DP @ - U. .( bytes left in dictionary.)               CR CR                                                           ;S                                                                                                                                                                                                                                                                                                                              ( Demo program to dump a file using DOS2.0 interface 09/15/83 ) FORTH DEFINITIONS DECIMAL                                                                                                         VARIABLE DUMP-BASE                                            : DUMP-BUFFER  ( addr  n  ---  )                                  OVER DUMP-BASE ! BASE @ >R HEX CR CR 5 SPACES                   16 0 DO I 3 .R LOOP 2 SPACES                                    16 0 DO I 0 <# # #> TYPE LOOP CR                                OVER + SWAP DO                                                  CR I DUMP-BASE @ - 0 4 D.R SPACE                                I 16 + I 2DUP                                                     DO I C@ SPACE 0 <# # # #> TYPE LOOP 2 SPACES                    DO I C@ DUP 32 < OVER 126 > OR IF DROP 46 THEN EMIT LOOP      16 +LOOP CR R> BASE ! ;                                       -->                                                                                                                             ( Demo program to dump a file using DOS2.0 interface 09/15/83 )                                                                 HANDLE FILE1                                                                                                                      VARIABLE BUFFER 128 ALLOT                                                                                                     -1 CONSTANT EOF                                                                                                                   VARIABLE RECORD                                                                                                               : GET-FILENAME  CR CR ." Enter Path and Filename:  "                            FILE1 INPUT-FILENAME  CR CR ;                   -->                                                                                                                                                                                                                                                             ( Demo program to dump a file using DOS2.0 interface 09/15/83 )                                                                 : OPEN-IT       FILE1 OPEN-FILE                                                 IF CR ." Can't open file" CR QUIT THEN ;        : CLOSE-IT      FILE1 CLOSE-FILE DROP ;                         : READ-IT       FILE1 128 BUFFER READ ;                         : DUMP-FILE     DECIMAL  GET-FILENAME                                           OPEN-IT    0 RECORD !                                           CR CR ." Push any key to abort dump." CR CR                     BEGIN  ?TERMINAL IF KEY DROP CR CR QUIT                                THEN  READ-IT  EOF <>                                    WHILE  DROP CR CR ." Record " RECORD @ .                               BUFFER 128 DUMP-BUFFER 1 RECORD +!                       REPEAT CR CR CLOSE-IT ;                         ;S                                                                                                                              ( Test standard input and output handles             09/16/83 ) ( note that a carriage return and line feed are appended to the input string and are included in the length returned by READ )  DECIMAL         ( uses default buffer at 80 H for text I/O )    : TEST-IT       CLEARSCREEN                                                     ." Test standard input/output handles." CR CR                   ." Enter max of 80 bytes of text, "                             ." followed by a carriage return."  CR CR                       STD-INPUT 80 ( length ) 128 ( buffer )  READ                    DROP CR CR DUP .                                                ." bytes were read from the standard input."                    CR CR ." Here is what you entered:" CR CR                       >R STD-OUTPUT R> ( length ) 128 ( buffer) WRITE                 CR CR DROP .                                                    ." bytes were written to the standard output."                  CR CR ;                                         ( Convert screen file to standard text file          09/17/83 )                                                                 FORTH DEFINITIONS DECIMAL                                                                                                       HANDLE IFILE    ( input file )                                  HANDLE OFILE    ( output file )                                                                                                   VARIABLE BUFFER  128 ALLOT                                                                                                    13 CONSTANT ASCII_CR                                            10 CONSTANT ASCII_LF                                                                                                            -1 CONSTANT EOF                                                 -->                                                                                                                                                                                             ( Convert screen file to standard text file          09/17/83 )                                                                 ( --- )                                                         : GET_FILE_NAMES                                                        BEGIN   CR                                                      CR ." Enter name of source file:      "                         IFILE INPUT-FILENAME                                            CR ." Enter name of destination file: "                         OFILE INPUT-FILENAME    CR                                      CR ." Source file      = " IFILE .FILENAME                      CR ." Destination file = " OFILE .FILENAME                      CR CR ." OK? " KEY   DUP EMIT  32 OR    ASCII y =               UNTIL   CR CR ;                                         -->                                                                                                                                                                                             ( Convert screen file to standard text file          09/17/83 )                                                                 ( --- )                                                         : OPEN_FILES    IFILE OPEN-FILE                                                 IF CR ." Source file not found" CR QUIT                         THEN OFILE MAKE-FILE                                            IF CR ." Can't make destination file" CR QUIT                   THEN ;                                                                                                          ( --- )                                                         : CLOSE_FILES   IFILE CLOSE-FILE                                                IF CR ." Error closing source file" CR                          THEN OFILE CLOSE-FILE                                           IF CR ." Error closing destination file" CR                     THEN  ;                                         -->                                                             ( Convert screen file to standard text file          09/17/83 )                                                                 ( --- status )                                                  : READ_FORTH_LINE       IFILE 64 BUFFER READ ;                                                                                  ( --- length )                                                  : FORTH_TO_TXT          BUFFER 64 -TRAILING SWAP DROP                                   ASCII_CR OVER BUFFER + C! 1+                                    ASCII_LF OVER BUFFER + C! 1+ ;                                                                          -->                                                                                                                                                                                                                                                                                                                                                                                             ( Convert screen file to standard text file          09/17/83 )                                                                 ( length --- )                                                  : WRITE_TXT_LINE        >R OFILE R@ BUFFER WRITE                                        IF CR ." Error writing destination file"                           CR QUIT                                                      THEN R> <>                                                      IF CR ." Destination media is full"                                CR QUIT                                                      THEN ;                                                                                                                                                                  -->                                                                                                                                                                                                                                                             ( Convert screen file to standard text file          09/17/83 )                                                                 : CONVERT       CLEARSCREEN                                                     ." Convert screen file to standard text file"                   GET_FILE_NAMES  OPEN_FILES                                      CR ." Processing..."                                            BEGIN  READ_FORTH_LINE  EOF <>                                  WHILE  DROP FORTH_TO_TXT WRITE_TXT_LINE                         REPEAT CR CR                                                    IFILE ?FILESIZE                                                 CR ." Source file =      " D.  ." bytes"                        OFILE ?FILESIZE                                                 CR ." Destination file = " D. ." bytes"                         CLOSE_FILES                                                     CR CR ." Conversion completed." CR CR ;                                                                         ( Illustration of creating & changing subdirectories 09/19/83 )                                                                 DIRECTORY SUB1          ( establish directory control block )   SUB1 DIRNAME \SUB1      ( insert subdirectory name )                                                                            HANDLE FILE1            ( establish handle control block )      FILE1 FILENAME QUACK.XYZ  ( insert file name into HCB )                                                                         SUB1 MAKE-DIR .STATUS   ( create subdirectory )                 SUB1 CHANGE-DIR .STATUS ( change current directory to SUB1 )    FILE1 MAKE-FILE .STATUS ( create a file in sub1 )               ROOT CHANGE-DIR .STATUS ( change current directory to \ )                                                                                                                                                                                                                                                                       